<%- include('partials/header') %>

  <p class="lead text-body-secondary">
    Galda spÄ“les ir kas vairÄk nekÄ tikai izklaide â€“ tÄs ir veids, kÄ pavadÄ«t kvalitatÄ«vu laiku kopÄ ar Ä£imeni un
    draugiem.
    TÄs apvieno stratÄ“Ä£iju, veiksmi un radoÅ¡u domÄÅ¡anu, sniedzot ne tikai prieku, bet arÄ« izaicinÄjumus.
  </p>
  <p class="lead text-body-secondary">
    SpÄ“Ä¼u vakari ir lieliska iespÄ“ja atslÄ“gties no ikdienas steigas, izbaudot Ä«stu cilvÄ“ku mijiedarbÄ«bu un jautrÄ«bu.
    Galda spÄ“les veicina komandas darbu, uzlabo komunikÄcijas prasmes un pat attÄ«sta loÄ£isko domÄÅ¡anu.
  </p>
  <p class="lead text-body-secondary">
    Ienirsti galda spÄ“Ä¼u pasaulÄ“ un atklÄj to prieku, ko sniedz kopÄ bÅ«Å¡ana un aizrautÄ«gas cÄ«Å†as pie spÄ“Ä¼u galda!
  </p>

  <h1 class="mb-4">SpÄ“Ä¼u kolekcija</h1>

  <!-- MeklÄ“Å¡anas un filtrÄ“Å¡anas forma -->
  <form method="GET" action="/" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" value="<%= search || '' %>" class="form-control"
        placeholder="MeklÄ“t pÄ“c nosaukuma...">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">Visas kategorijas</option>
        <% categories.forEach(cat=> { %>
          <option value="<%= cat %>" <%=category===cat ? 'selected' : '' %>><%= cat %>
          </option>
          <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort" class="form-select" onchange="this.form.submit()">
        <option value="alphabet" <%=sort==='alphabet' || !sort ? 'selected' : '' %>>AlfabÄ“ta secÄ«bÄ</option>
        <option value="rating" <%=sort==='rating' ? 'selected' : '' %>>VidÄ“jÄ vÄ“rtÄ“juma â†“</option>
        <option value="age" <%=sort==='age' ? 'selected' : '' %>>Vecuma â†“</option>
        <option value="players" <%=sort==='players' ? 'selected' : '' %>>SpÄ“lÄ“tÄju skaita â†“</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-custom w-100">MeklÄ“t</button>
    </div>
  </form>

  <!-- SpÄ“Ä¼u kartÄ«tes -->
  <div class="row">
    <% if (games.length===0) { %>
      <div class="col-12">
        <p class="text-muted">Nav atrastu spÄ“Ä¼u ar Å¡iem filtriem.</p>
      </div>
      <% } else { %>
        <% games.forEach(game=> {
          let avg = 0;
          let fullDice = 0;
          let halfDice = 0;
          let emptyDice = 5;

          if (game.ratings && game.ratings.length > 0) {
          avg = game.ratings.reduce((sum, r) => sum + r.score, 0) / game.ratings.length;
          fullDice = Math.floor(avg);
          halfDice = (avg - fullDice) >= 0.5 ? 1 : 0;
          emptyDice = 5 - fullDice - halfDice;
          }
          %>
          <div class="col-md-4 mb-4">
            <a href="/game/<%= game._id %>" class="text-decoration-none text-dark">
              <div class="card h-100 d-flex flex-column">
                <% if (game.image) { %>
                  <img src="<%= game.image %>" class="card-img-top game-image" alt="<%= game.title %>">
                  <% } else { %>
                    <div class="card-img-top placeholder-image d-flex align-items-center justify-content-center">
                      <span class="text-white">Nav attÄ“la</span>
                    </div>
                    <% } %>

                      <% if (game.ratings && game.ratings.length> 0) { %>
                        <div class="rating-big" style="font-size: 2rem;">
                          <% for (let i=0; i < fullDice; i++) { %>
                            <span>ğŸ²</span>
                            <% } %>
                              <% if (halfDice) { %>
                                <span style="opacity: 0.5;">ğŸ²</span>
                                <% } %>
                                  <% for (let i=0; i < emptyDice; i++) { %>
                                    <span style="opacity: 0.2;">ğŸ²</span>
                                    <% } %>
                                      <span class="ms-2 text-muted" style="font-size: 2rem;">
                                        (<%= avg.toFixed(1) %>/5)
                                      </span>
                        </div>
                        <% } else { %>
                          <div class="rating-big" style="font-size: 2rem; opacity: 0.3;">
                            <span>ğŸ²ğŸ²ğŸ²ğŸ²ğŸ²</span>
                            <span class="ms-2">(-/5)</span>
                          </div>
                          <% } %>

                            <div class="card-body d-flex flex-column">
                              <h5 class="card-title">
                                <%= game.title %>
                              </h5>
                              <h6 class="text-muted">
                                <%= game.subtitle %>
                              </h6>
                              <p class="card-text">
                                <%= game.description.length> 250 ? game.description.slice(0, 250) + "..." :
                                  game.description %>
                              </p>
                              <div class="mt-auto">
                                <span class="btn btn-custom">LasÄ«t vairÄk</span>
                              </div>
                            </div>
              </div>
            </a>
          </div>
          <% }) %>
            <% } %>
  </div>

  <%- include('partials/footer') %>