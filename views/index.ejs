<%- include('partials/header') %>

  <p class="lead text-body-secondary">
    Galda spēles ir kas vairāk nekā tikai izklaide – tās ir veids, kā pavadīt kvalitatīvu laiku kopā ar ģimeni un
    draugiem.
    Tās apvieno stratēģiju, veiksmi un radošu domāšanu, sniedzot ne tikai prieku, bet arī izaicinājumus.
  </p>
  <p class="lead text-body-secondary">
    Spēļu vakari ir lieliska iespēja atslēgties no ikdienas steigas, izbaudot īstu cilvēku mijiedarbību un jautrību.
    Galda spēles veicina komandas darbu, uzlabo komunikācijas prasmes un pat attīsta loģisko domāšanu.
  </p>
  <p class="lead text-body-secondary">
    Ienirsti galda spēļu pasaulē un atklāj to prieku, ko sniedz kopā būšana un aizrautīgas cīņas pie spēļu galda!
  </p>

  <h1 class="mb-4">Spēļu kolekcija</h1>

  <!-- Meklēšanas un filtrēšanas forma -->
  <form method="GET" action="/" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" value="<%= search || '' %>" class="form-control"
        placeholder="Meklēt pēc nosaukuma...">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">Visas kategorijas</option>
        <% categories.forEach(cat=> { %>
          <option value="<%= cat %>" <%=category===cat ? 'selected' : '' %>><%= cat %>
          </option>
          <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort" class="form-select" onchange="this.form.submit()">
        <option value="alphabet" <%=sort==='alphabet' || !sort ? 'selected' : '' %>>Alfabēta secībā</option>
        <option value="rating" <%=sort==='rating' ? 'selected' : '' %>>Vidējā vērtējuma ↓</option>
        <option value="age" <%=sort==='age' ? 'selected' : '' %>>Vecuma ↓</option>
        <option value="players" <%=sort==='players' ? 'selected' : '' %>>Spēlētāju skaita ↓</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-custom w-100">Meklēt</button>
    </div>
  </form>

  <!-- Spēļu kartītes -->
  <div class="row">
    <% if (games.length===0) { %>
      <div class="col-12">
        <p class="text-muted">Nav atrastu spēļu ar šiem filtriem.</p>
      </div>
      <% } else { %>
        <% games.forEach(game=> {
          let avg = 0;
          let fullDice = 0;
          let halfDice = 0;
          let emptyDice = 5;

          if (game.ratings && game.ratings.length > 0) {
          avg = game.ratings.reduce((sum, r) => sum + r.score, 0) / game.ratings.length;
          fullDice = Math.floor(avg);
          halfDice = (avg - fullDice) >= 0.5 ? 1 : 0;
          emptyDice = 5 - fullDice - halfDice;
          }
          %>
          <div class="col-md-4 mb-4">
            <a href="/game/<%= game._id %>" class="text-decoration-none text-dark">
              <div class="card h-100 d-flex flex-column">
                <% if (game.image) { %>
                  <img src="<%= game.image %>" class="card-img-top game-image" alt="<%= game.title %>">
                  <% } else { %>
                    <div class="card-img-top placeholder-image d-flex align-items-center justify-content-center">
                      <span class="text-white">Nav attēla</span>
                    </div>
                    <% } %>

                      <% if (game.ratings && game.ratings.length> 0) { %>
                        <div class="rating-big" style="font-size: 2rem;">
                          <% for (let i=0; i < fullDice; i++) { %>
                            <span>🎲</span>
                            <% } %>
                              <% if (halfDice) { %>
                                <span style="opacity: 0.5;">🎲</span>
                                <% } %>
                                  <% for (let i=0; i < emptyDice; i++) { %>
                                    <span style="opacity: 0.2;">🎲</span>
                                    <% } %>
                                      <span class="ms-2 text-muted" style="font-size: 2rem;">
                                        (<%= avg.toFixed(1) %>/5)
                                      </span>
                        </div>
                        <% } else { %>
                          <div class="rating-big" style="font-size: 2rem; opacity: 0.3;">
                            <span>🎲🎲🎲🎲🎲</span>
                            <span class="ms-2">(-/5)</span>
                          </div>
                          <% } %>

                            <div class="card-body d-flex flex-column">
                              <h5 class="card-title">
                                <%= game.title %>
                              </h5>
                              <h6 class="text-muted">
                                <%= game.subtitle %>
                              </h6>
                              <p class="card-text">
                                <%= game.description.length> 250 ? game.description.slice(0, 250) + "..." :
                                  game.description %>
                              </p>
                              <div class="mt-auto">
                                <span class="btn btn-custom">Lasīt vairāk</span>
                              </div>
                            </div>
              </div>
            </a>
          </div>
          <% }) %>
            <% } %>
  </div>

  <%- include('partials/footer') %>